<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Tracing Chromecast Traffic
| Damitha Gunawardena @damithag</title><link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono:300,400,700" rel=stylesheet><link rel=stylesheet href=/book.min.a3caa905766cf610e263c876d2f2d8477f59d64606267bcaeee26e73160f9285.css><link rel=icon href=/favicon.png type=image/x-icon></head><body><input type=checkbox style=display:none id=menu-control><main class="flex container"><aside class="book-menu fixed"><nav role=navigation><h2 class=book-brand><a href=https://www.damitha.xyz/>Damitha Gunawardena @damithag</a></h2><ul><li><span>Coding</span><ul><li><a href=/docs/coding/alexa-i-cannot-hear-you/>Alexa I Cannot Hear You</a></li><li><a href=/docs/coding/tracing-chromecast-traffic/ class=active>Tracing Chromecast Traffic</a></li></ul></li><li><span>Hobby Projects</span><ul><li><span>Smart Home</span><ul><li><a href=/docs/hobby-projects/smart-home/intro/>Intro</a></li></ul></li><li><a href=/docs/hobby-projects/automated-cabling-diagrams/>Automated Cabling Diagrams</a></li></ul></li><li><a href=/docs/wishlist/>Wishlist</a></li></ul></nav></aside><div class=book-page><header class="align-center justify-between book-header"><label for=menu-control><img src=/svg/menu.svg alt=Menu></label>
<strong>Tracing Chromecast Traffic</strong></header><article class=markdown><h1 id=tracing-chromecast-traffic-via-mac>Tracing Chromecast traffic via Mac</h1><p>Had problem at work where we need to see debug Chromecast streaming traffic. Chromecast doesn&rsquo;t allow us to change network config manually. Thus needed to force traffic via default gateway where I was able to run mitmproxy</p><h2 id=having-the-abiliy-to-provide-dhcp-leases>Having the abiliy to provide DHCP leases</h2><p>dnsmasq provides the ability to do that. Quite a simple config</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>brew install dnsmasq</code></pre></div><h3 id=dnsmasq-config>dnsmasq config</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dhcp-range<span style=color:#666>=</span><span style=color:#666>10</span>.0.0.32,10.0.0.248,255.255.255.0,2h
<span style=color:#408080;font-style:italic># Gateway</span>
dhcp-option<span style=color:#666>=</span><span style=color:#666>3</span>,10.0.0.4
<span style=color:#408080;font-style:italic># DNS (This is where your transparent proxy runs )</span>
dhcp-option<span style=color:#666>=</span><span style=color:#666>6</span>,10.0.0.1</code></pre></div><h3 id=start-dnsmasq>start dnsmasq</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/usr/local/sbin/dnsmasq -C dnsmasq.conf</code></pre></div><h2 id=getting-the-mac-to-act-as-a-router>Getting the mac to act as a router</h2><h3 id=enable-ip-forwarding>Enable IP forwarding</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo sysctl -w net.inet.ip.forwarding<span style=color:#666>=</span><span style=color:#666>1</span></code></pre></div><h3 id=forward-http-and-https-traffic-to-port-8080>forward http and https traffic to port 8080</h3><p>Create a file called pf.conf, have the following config. If you want only port 80 remove 443</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rdr on en0 inet proto tcp to any port <span style=color:#666>{</span><span style=color:#666>80</span>, <span style=color:#666>443</span><span style=color:#666>}</span> -&gt; <span style=color:#666>127</span>.0.0.1 port <span style=color:#666>8080</span></code></pre></div><p>config pf.conf with the rules and enable it</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo pfctl -f pf.conf
sudo pfctl -e</code></pre></div><h2 id=run-mitmproxy-on-the-mac>Run mitmproxy on the mac</h2><h3 id=configure-sudoers-to-allow-mitmproxy-to-access-pfctl>Configure sudoers to allow mitmproxy to access pfctl.</h3><p>In /etc/sudoers</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ALL <span style=color:#19177c>ALL</span><span style=color:#666>=</span>NOPASSWD: /sbin/pfctl -s state</code></pre></div><h3 id=fire-up-mitmproxy>Fire up mitmproxy</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mitmproxy --mode transparent --showhost</code></pre></div></article></div><aside class="book-toc fixed"><nav id=TableOfContents><ul><li><a href=#tracing-chromecast-traffic-via-mac>Tracing Chromecast traffic via Mac</a><ul><li><a href=#having-the-abiliy-to-provide-dhcp-leases>Having the abiliy to provide DHCP leases</a><ul><li><a href=#dnsmasq-config>dnsmasq config</a></li><li><a href=#start-dnsmasq>start dnsmasq</a></li></ul></li><li><a href=#getting-the-mac-to-act-as-a-router>Getting the mac to act as a router</a><ul><li><a href=#enable-ip-forwarding>Enable IP forwarding</a></li><li><a href=#forward-http-and-https-traffic-to-port-8080>forward http and https traffic to port 8080</a></li></ul></li><li><a href=#run-mitmproxy-on-the-mac>Run mitmproxy on the mac</a><ul><li><a href=#configure-sudoers-to-allow-mitmproxy-to-access-pfctl>Configure sudoers to allow mitmproxy to access pfctl.</a></li><li><a href=#fire-up-mitmproxy>Fire up mitmproxy</a></li></ul></li></ul></li></ul></nav></aside></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1344482-5','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>